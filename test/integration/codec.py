import re
import unittest
from ir_datasets.datasets.codec import CodecQuery
from ir_datasets.formats import TrecQrel
from .base import DatasetIntegrationTest


class TestCodec(DatasetIntegrationTest):
    def test_queries(self):
        self._test_queries('codec', count=36, items={
            0: CodecQuery('economics-1', "How has the UK's Open Banking Regulation benefited challenger banks?", 'UK’s Open Banking regulation, which has parallels to the EU’s second payment service directive (PSD2), went live in January 2018. This piece of legislation “will require banks to open their payments infrastructure and customer data assets to third parties”. As a result, banks no longer have a monopoly on user data if clients grant permission. \n\nChallenger banks are small, recently created retail banks that compete directly with the longer-established banks in the UK. Specifically, seeking market share from the "big four" UK retail banks (Barclays, HSBC, Lloyds Banking Group, and NatWest Group). The banks distinguish themselves from the historic banks by modern financial technology practices, such as online-only operations, that avoid the costs and complexities of traditional banking. The largest UK-operating challenger banks include Atom Bank, Revolut, Starling, N26, and Tide.\n\nRelevant documents and entities will discuss how challenger banks have used open banking to develop new products or capture market share from traditional retail banks in the UK.'),
            9: CodecQuery('economics-20', 'Are private capital markets so plentiful that there is no need for startups to IPO?', 'Private capital markets have been increasingly attracting more money, i.e. the rise in venture capital and private equity asset classes. Several decades ago, fast-growing startups "had" to IPO relatively early due to capital requirements. Now, startups can raise billions of dollars in private markets without the risk or transparency of an IPO (Revolut, Uber, We Work, etc.). Nonetheless, IPO-ing is still extremely popular - even if happening later - IPOs allow early investors/founders to exit and institutional investors to provide larger amounts of capital to fund growth.'),
            35: CodecQuery('politics-23', 'Is the rise of European populism a threat to the European Union?', '"Populist" is a broad term that describes, typically a politician, who targets people who feel that established elite groups disregard their concerns. Some critics highlight negative connotations, including criticising foreign migration or minorities.\n\nIn recent years, populism has been stronger in Eastern Europe, i.e. Bulgaria, Hungary, Austrian, and Poland, etc. have seen the rise of populist politicians. Right-wing populist movements have also gained momentum in France, Spain, the United Kingdom and other parts of Europe. In Hungary and Poland, some critics argue this has led to an erosion of the rule of law, increased persecution, and authoritarianism.\n\nEuropean Union is a political union of democratic nations. However, radical right-wing politics reject what the EU stands for and how it works, i.e. against European supranational integration and push for national policies. Populists also criticise the EU\'s perceived bureaucracy and failures - common arguments during the Brexit Leave campaign. The EU is founded based on shared democratic values that countries need to be relatively ideologically aligned to function within a political union. There is also the threat that disillusioned Eastern European countries will turn away from the EU and toward Russia.'),
        })
        self._test_queries('codec/economics', count=12, items={
            0: CodecQuery('economics-1', "How has the UK's Open Banking Regulation benefited challenger banks?", 'UK’s Open Banking regulation, which has parallels to the EU’s second payment service directive (PSD2), went live in January 2018. This piece of legislation “will require banks to open their payments infrastructure and customer data assets to third parties”. As a result, banks no longer have a monopoly on user data if clients grant permission. \n\nChallenger banks are small, recently created retail banks that compete directly with the longer-established banks in the UK. Specifically, seeking market share from the "big four" UK retail banks (Barclays, HSBC, Lloyds Banking Group, and NatWest Group). The banks distinguish themselves from the historic banks by modern financial technology practices, such as online-only operations, that avoid the costs and complexities of traditional banking. The largest UK-operating challenger banks include Atom Bank, Revolut, Starling, N26, and Tide.\n\nRelevant documents and entities will discuss how challenger banks have used open banking to develop new products or capture market share from traditional retail banks in the UK.'),
            9: CodecQuery('economics-20', 'Are private capital markets so plentiful that there is no need for startups to IPO?', 'Private capital markets have been increasingly attracting more money, i.e. the rise in venture capital and private equity asset classes. Several decades ago, fast-growing startups "had" to IPO relatively early due to capital requirements. Now, startups can raise billions of dollars in private markets without the risk or transparency of an IPO (Revolut, Uber, We Work, etc.). Nonetheless, IPO-ing is still extremely popular - even if happening later - IPOs allow early investors/founders to exit and institutional investors to provide larger amounts of capital to fund growth.'),
            11: CodecQuery('economics-23', 'Offering non-accounting services arguably creates a conflict of interest for the Big Four. Is this the reason for their inability to uncover recent financial scandals?', 'The Big Four are the four largest global accounting firms that dominate corporate accounting, i.e. Deloitte, Ernst & Young (EY), PricewaterhouseCoopers (PwC), and Klynveld Peat Marwick Goerdeler (KPMG). As well as offering accounting services, these firms also over other many higher-margin services such as tax, consultancy, and technology services (~80% revenue). \n\nInternal controls (firewalls, departments, etc.) are meant to prohibit any cooperation between audit and non-audit services in winning customer contracts or favour. However, critics would argue that this does not go far enough and can lead to less rigorous audits, calling for the Big Four to be broken up. Critics highlight poor practices in recent accounting scandals, including  Wirecard, Carillion, Satyam Computer Services, South Africa examples, etc. \n\nHowever, it should be highlighted that even if the Big Four were separated, this would not necessarily lead to no accounting scandals. Some fraudulent practices may be hard to catch even if objective and following best practices. Also, there are other areas of possible conflict of interest that non-accounting work, including how the corporate hires the auditor.'),
        })
        self._test_queries('codec/history', count=12, items={
            0: CodecQuery('history-1', 'Would the United Kingdom have been ready for WWII without the time gained through Appeasement?', "Many argue Britain's army was depleted in the early 1930s and stretched across the globe. UK defence spending had fallen significantly during the 1920s, from over £700 million in 1919 to 100 million in 1931.\n\nBetween 1934 and 1939, the UK launched a substantial programme of re-arming, recognising that war with Hitler was becoming increasingly likely. Although Appeasement was also motivated by Chamberlain's desire to end war, some argue this meant that the UK was more prepared in 1939 when war eventually broke out.  \n\nDespite these efforts, Germany was still better prepared for war under Hilter's single-minded preparation since he came to power in 1933. However, without Appeasement, the differential might have been much worse."),
            9: CodecQuery('history-19', 'How close did the world come to nuclear war during the Cuban Missile Crisis?', 'During the Cuban Missile Crisis, leaders of the United States and the Soviet Union engaged in a 13-day political and military standoff in October 1962 over the installation of nuclear-armed Soviet missiles on Cuba. This was the peak of the Cold War and a high-stakes political and military situation, given the potential devastation of nuclear weapons. However, exactly how close we came to nuclear armageddon is still debated. \n\nThe political leaders within this crisis were JFK for the United States, Nikita Khrushchev of the Soviet Union, and Fidel Casto of Cuba. Many highlights that JFK and Khrushchev were measured in their leadership styles and understood nuclear war meant mutual destruction. Some highlight exchanging of letters and other communications to prevent a nuclear war. Nonetheless, many highlight the mistrust and fear between both sides and how a single false move could have led to a disaster. Both sides were actively preparing for a nuclear war, and some within each camp through nuclear strikes was likely.'),
            11: CodecQuery('history-25', 'How responsible was Rasputin for the fall of the Romanov dynasty?', "The Russian Tsar, Nicholas II, abdicated from power in 1917, bringing the 300-year-old Romanov dynasty to an end. Some historians suggest that Grigori Rasputin's scandalous reputation helped discredit the Tsarist government and helped to lay the foundation for the Russian Revolution. \n\nHowever, many historians argue that although Rasputin was a useful propaganda tool against the Tsar, much larger factors were at play. For example, Nicholas II was viewed as a weak leader, the Russo-Japanese War, Bloody Sunday, Tsarina unpopularity, and WWI. There was also significant economic issues, including inflation and food shortages."),
        })
        self._test_queries('codec/politics', count=12, items={
            0: CodecQuery('politics-1', 'Is Scottish Independence inevitable?', "This questions focuses on the long-term political, economic and social reasoning behind whether Scotland will likely become independent. Short-term facts and opinions are less central to this question.\n\nSome argue that Scottish independence is inevitable given the surge of support towards SNP in recent decades. Labour has lost political weight in Scotland since the Blair era, and Conservatives historically struggle to penetrate a more left-wing Scottish demographic. Brexit further exacerbated this political unease, i.e. right-leaning Britain and left-leaning Scotland. While the younger demographic is more likely to be independence supporters and the older demographic is more likely to be pro-union.\n\nThere are several arguments that Scotland independence is not inevitable. Historically there has been a union for 300+ years covering a full range of circumstances (world wars, successes). Economically, Britain funds lots of Scottish spending through Barnett-based funding, Scotland's oil is less valuable than previously, and there is much economic uncertainly around currency and debt. Some also argue that Scotland has large political independence due to devolution; thus, independence is unnecessary."),
            9: CodecQuery('politics-20', 'Should social media companies be held liable for content and actions made by their users?', 'Social media companies (Facebook, Twitter, Google, etc.) have been under increasing public and political pressure regarding content and actions made by users on platforms. For example, if a graphic or illegal video is posted on Facebook, Youtube or Twitter, how much liability lies with the person posting versus the company hosting the video? \n\nSome argue that Social Media, and the internet in general, needs to be protected as a means for people to interact openly, pointing to many of the positives social media has brought, i.e. political activism, online discussion, etc. This support the legal position that Social Media is not a publisher but allows people to publish their content. \n\nHowever, others argue that Social Media has a duty of care to users and should remove content that violates their terms and conditions (this commonly happens today). Therefore, have share liability with users. The issue inforcing this is twofold (1) real-time speed and scale of social media, and (2) when content is controversial but less illegal. Nonetheless, many countries worldwide have been pushing towards Social Media companies having increased liability for their content, although this is a legislative challenge.'),
            11: CodecQuery('politics-23', 'Is the rise of European populism a threat to the European Union?', '"Populist" is a broad term that describes, typically a politician, who targets people who feel that established elite groups disregard their concerns. Some critics highlight negative connotations, including criticising foreign migration or minorities.\n\nIn recent years, populism has been stronger in Eastern Europe, i.e. Bulgaria, Hungary, Austrian, and Poland, etc. have seen the rise of populist politicians. Right-wing populist movements have also gained momentum in France, Spain, the United Kingdom and other parts of Europe. In Hungary and Poland, some critics argue this has led to an erosion of the rule of law, increased persecution, and authoritarianism.\n\nEuropean Union is a political union of democratic nations. However, radical right-wing politics reject what the EU stands for and how it works, i.e. against European supranational integration and push for national policies. Populists also criticise the EU\'s perceived bureaucracy and failures - common arguments during the Brexit Leave campaign. The EU is founded based on shared democratic values that countries need to be relatively ideologically aligned to function within a political union. There is also the threat that disillusioned Eastern European countries will turn away from the EU and toward Russia.'),
        })

    def test_qrels(self):
        self._test_qrels('codec', count=5130, items={
            0: TrecQrel('economics-1', '04ca4c9d467c901f1b7bdcb8297e2dc5', 0, 'Q0'),
            9: TrecQrel('economics-1', '1326691620787cdc5fcda87be0768bc0', 0, 'Q0'),
            5129: TrecQrel('politics-23', 'fe8b7fb9c1b8929c5e72db81acebd178', 2, 'Q0'),
        })
        self._test_qrels('codec/economics', count=1592, items={
            0: TrecQrel('economics-1', '04ca4c9d467c901f1b7bdcb8297e2dc5', 0, 'Q0'),
            9: TrecQrel('economics-1', '1326691620787cdc5fcda87be0768bc0', 0, 'Q0'),
            1591: TrecQrel('economics-23', 'fba8224d36650f17c9da86584315fbb2', 0, 'Q0'),
        })
        self._test_qrels('codec/history', count=1695, items={
            0: TrecQrel('history-1', '02db8ac36f69945343596a86bbba63a5', 0, 'Q0'),
            9: TrecQrel('history-1', '1962a968db6aebf41247cb496bc3a1d5', 0, 'Q0'),
            1694: TrecQrel('history-25', 'fde05d9b82e625391817f280c0b7a6da', 1, 'Q0'),
        })
        self._test_qrels('codec/politics', count=1843, items={
            0: TrecQrel('politics-1', '001a26a856233944ab552886dddb5dc6', 1, 'Q0'),
            9: TrecQrel('politics-1', '0e6b7da151bef0c52716a06eee7ad319', 2, 'Q0'),
            1842: TrecQrel('politics-23', 'fe8b7fb9c1b8929c5e72db81acebd178', 2, 'Q0'),
        })


if __name__ == '__main__':
    unittest.main()
